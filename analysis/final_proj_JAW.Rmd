---
title: "Member versus Casual Final Project"
question: "Is there a spatial pattern driven by members vs. casual riders?"
date:  "2022-12-2"
authors: "Joseph White, Sarah Kohls, Michael Lanfear"
output: html_notebook
---

##Website used to compare where the "touristy" areas are = https://www.flickr.com/photos/walkingsf/4672195208
##Blue dots represent where pictures are taken by locals
##Red dots represent where pictures are taken by tourists
##Yellow dots could be from either

## Install lehdr
Run this code only once.
```{r}
#devtools::install_github("jamgreen/lehdr")
```

## Packages
```{r}
library(knitr)
library(tidyverse)
library(janitor)
library(lubridate)
library(here) 
library(sf) 
library(tmap)
library(tidycensus)
library(lehdr)
library(rnaturalearth)
library(WDI)
library(tigris)
library(rgdal)
library(sp)
library(dsbox)
```


## Downloading Census Data
Key points
-Downloading basic census data with the geography and population of DC in 2021
-Turn census data wide to get population data as a column

```{r}
census_api_key("d44395e2fa101f82260fae6b845676d71f017b70")

census=get_acs(geography = "tract",
               variables = c("pop"="B01001_001"),
               state="DC", geometry = TRUE,year=2021)

census_wide = census %>% select(-moe) %>% spread(variable, estimate) %>%
  select(GEOID, pop, geometry) %>% st_transform(4326)
```

## Downloading Bike Data
Key points
-Reading bike data from 2021
-Selecting member status, start latitude and longitude, making latitude and longitude geospacial data
-Create data sets for casual vs member riders
-Create one data set where member and casual variables have a row each, find percentages of riders in each polygon

```{r}
bikeshare = read_csv("202209-capitalbikeshare-tripdata.csv") %>% clean_names()

bikeshare_start = bikeshare %>% select(member_casual, start_lng, start_lat) %>% st_as_sf(coords=c("start_lng","start_lat"), crs=st_crs(census_wide))

bikeshare_start_member = bikeshare_start %>% filter(member_casual == "member")

tot_member = nrow(bikeshare_start_member)

bikeshare_start_casual = bikeshare_start %>% filter(member_casual == "casual")

tot_casual = nrow(bikeshare_start_casual)

bike_census = census_wide %>% mutate(start_count_member = lengths(st_intersects(., bikeshare_start_member))) %>% mutate(start_count_member_perc = start_count_member/tot_member)

bike_census = bike_census %>% mutate(start_count_casual = lengths(st_intersects(., bikeshare_start_casual))) %>% mutate(start_count_casual_perc = start_count_casual/tot_casual)
```
```{r}
tot_casual
tot_member
```

# Plot Our Data
```{r}
tmap_mode("view")
tm_shape(bike_census) + tm_polygons(c("start_count_member_perc","start_count_casual_perc"))
```

##Observations

From looking at the graphs above, you can see that casual riders (which are usually tourists), are riding way more 
often in area "11001980000" which is where all the tourist attractions and sight-seeing places are. 

However the member percentage is more spread out into other parts of D.C. because these are local people using the bike
share program to get to and from work, or go about their daily activities.

Our hypothesis that the spatial pattern of members vs causal riders would show casual riders more condensed in one area was correct. 

## Lincoln Monument Coordinates
```{r}
linc_long <- -77.0502
linc_lat <- 38.8893
linc <- data.frame(linc_lat,linc_long) 
```

## Link Lincoln monument data with bike data
Key Points
-Take bikeshare data and select status and coordinates
-Create a data set for the Lincoln monument data
-Join these data sets so we can do calculations on the two

```{r}
boxp1 <- bikeshare %>% select(member_casual, start_lng, start_lat) %>% sample_n(1000)

boxp <- boxp1 %>% mutate(lat_linc = start_lng) %>% mutate(long_linc = lat_linc) %>% select(lat_linc, long_linc, member_casual) %>% sample_n(1000)

boxp[,'lat_linc'] = linc_lat
boxp[,'long_linc'] = linc_long

boxp2 <- left_join(boxp, boxp1, by = 'member_casual') %>% sample_n(1000)
```

## Using haversine
```{r}
haversine <- function(long1, lat1, long2, lat2, round = 3) {
  # convert to radians
  long1 = long1 * pi / 180
  lat1  = lat1  * pi / 180
  long2 = long2 * pi / 180
  lat2  = lat2  * pi / 180
  
  R = 6371 # Earth mean radius in km
  
  a = sin((lat2 - lat1)/2)^2 + cos(lat1) * cos(lat2) * sin((long2 - long1)/2)^2
  d = R * 2 * asin(sqrt(a))
  
  return( round(d,round) ) # distance in km
}
```

## Distance from Lincoln Memorial
```{r}
linc_dist <- boxp2 %>% mutate(distance = haversine(start_lng, start_lat, long_linc, lat_linc, round = 4))
```

## Boxplot
```{r}
df <- linc_dist %>% select(distance, member_casual) %>% filter(distance < 10)
ggplot(data = df)+
  geom_boxplot(aes(x= member_casual, y = distance)) + facet_wrap(~member_casual)
```

##Boxplot Observations

This further proves the analysis gotten from the graphs above. The "distance" label describes the distance between the bike ride taken from the Lincoln Memorial. We found the distance relative to the Lincoln Memorial because it is in the touristy area, so in theory the causal riders should have closer distances to the memorial than the members. This is shown in the box and whisker plot above. Also you can see that there are more instances of member bike rides being much further away from the memorial.  


